{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ client }} - Kunguroff & Partners{% endblock %}
{% block page_title %}{% trans "Клиент:" %} {{ client }}{% endblock %}

{% block page_actions %}
  <div class="btn-group">
    <a href="{% url 'clients:client_update' client.pk %}" class="btn btn-outline-primary">
      <i class="bi bi-pencil"></i> {% trans "Редактировать" %}
    </a>
    {% if user.role in 'director deputy_director' %}
      <a href="{% url 'clients:client_delete' client.pk %}" class="btn btn-outline-danger">
        <i class="bi bi-trash"></i> {% trans "Удалить" %}
      </a>
    {% endif %}
  </div>
{% endblock %}

{% block content %}
<div class="row">
  <!-- Основная информация -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">{% trans "Основная информация" %}</h5>
      </div>
      <div class="card-body">

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "ФИО:" %}</div>
          <div class="col-sm-8">
            {{ client.last_name }} {{ client.first_name }} {{ client.middle_name|default:'' }}
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "Телефон:" %}</div>
          <div class="col-sm-8">{{ client.phone }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "Email:" %}</div>
          <div class="col-sm-8">{{ client.email|default:"—" }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "Ответственный:" %}</div>
          <div class="col-sm-8">
            {% if client.primary_contact.all %}
              <ul class="list-group">
                {% for lawyer in client.primary_contact.all %}
                  <li class="list-group-item">
                    {{ lawyer.get_full_name|default:lawyer.username }}
                    ({{ lawyer.get_role_display }})
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <p class="text-muted mb-0">{% trans "Ответственные не назначены" %}</p>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Паспортные данные -->
  <div class="col-md-6">
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="card-title mb-0">{% trans "Паспортные данные" %}</h5>
      </div>
      <div class="card-body">

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "Паспорт:" %}</div>
          <div class="col-sm-8">{{ client.passport_series }} {{ client.passport_number }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "Кем выдан:" %}</div>
          <div class="col-sm-8">{{ client.passport_issued_by }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "Дата выдачи:" %}</div>
          <div class="col-sm-8">{{ client.passport_issue_date|date:"d.m.Y" }}</div>
        </div>

        <div class="row mb-3">
          <div class="col-sm-4 fw-bold">{% trans "Адрес регистрации:" %}</div>
          <div class="col-sm-8">{{ client.registration_address }}</div>
        </div>

        {% if client.residence_address %}
          <div class="row mb-3">
            <div class="col-sm-4 fw-bold">{% trans "Адрес проживания:" %}</div>
            <div class="col-sm-8">{{ client.residence_address }}</div>
          </div>
        {% endif %}

        {% if client.inn %}
          <div class="row mb-3">
            <div class="col-sm-4 fw-bold">{% trans "ИНН:" %}</div>
            <div class="col-sm-8">{{ client.inn }}</div>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>

<!-- Дела клиента -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">{% trans "Дела клиента" %}</h5>
    <a href="{% url 'cases:case_create' %}?client={{ client.pk }}" class="btn btn-sm btn-primary">
      <i class="bi bi-plus-circle"></i> {% trans "Добавить дело" %}
    </a>
  </div>

  <div class="card-body">
    {% if cases %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>{% trans "Название дела" %}</th>
              <th>{% trans "Категория" %}</th>
              <th>{% trans "Статус" %}</th>
              <th>{% trans "Прогресс" %}</th>
              <th>{% trans "Действия" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for case in cases %}
              <tr>
                <td>
                  <a href="{% url 'cases:case_detail' case.pk %}">{{ case.title }}</a>
                </td>
                <td>{{ case.category.get_name_display }}</td>
                <td>
                  <span class="badge bg-{% if case.status == 'completed' %}success{% elif case.status == 'in_progress' %}primary{% elif case.status == 'paused' %}warning{% else %}secondary{% endif %}">
                    {{ case.get_status_display }}
                  </span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height:10px;">
                      <div class="progress-bar" role="progressbar" style="width: {{ case.progress }}%;"
                           aria-valuenow="{{ case.progress }}" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <small>{{ case.progress }}%</small>
                  </div>
                </td>
                <td>
                  <a href="{% url 'cases:case_detail' case.pk %}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center text-muted py-4">
        <i class="bi bi-folder-x display-4"></i>
        <p class="mt-3 mb-0">{% trans "У клиента пока нет дел" %}</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Заметки -->
{% if client.notes %}
  <div class="card mt-4">
    <div class="card-header">
      <h5 class="card-title mb-0">{% trans "Заметки" %}</h5>
    </div>
    <div class="card-body">
      {{ client.notes|linebreaks }}
    </div>
  </div>
{% endif %}
{% endblock %}
